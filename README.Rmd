---
title: "glmnet (averissimo fork)"
output: 
  github_document:
    toc: true
    dev: png
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error = TRUE)
```

```{r, message=FALSE, warning=FALSE}
library(microbenchmark)
library(devtools)
library(futile.logger)
```

This is a fork that implements mclapply instead of foreach in cv.glmnet. With `~21%` gains when adding parallization to `cv.coxnet`.

The big improvement that can be seen in the tests below, is when adding `mclapply` in `cv.coxnet` for calculating deviances. It goes from `55s` to `43s` with this test dataset (`21%` average improvement).

# Load a common dataset

```{r data}
data("CoxExample", package = 'glmnet')
# number of repetitions
ntimes      <- list()
ntimes$x1   <- 10
ntimes$x10  <- 10
ntimes$x100 <- 10
#
new.x <- matrix(rep(x, 100), nrow = 1000, ncol = 3000)
new.x <- new.x + rnorm(length(new.x))
#
n.cores <- 1
```

# Local glmnet for tests

```{r, include=FALSE}
devtools::load_all('.', recompile = T)
```

```{r, eval=FALSE}
devtools::load_all('.', recompile = T)
```

```{r local, echo=FALSE}
#
using.mclapply <- function(var.num, mc.cores = n.cores) {cv.glmnet(new.x[,seq(var.num)], y, family = 'cox', mc.cores = mc.cores)}
```

## x1

```{r local_x1}
microbenchmark::microbenchmark(using.mclapply(30), times = ntimes$x1)
```

## x10

```{r local_x10}
microbenchmark::microbenchmark(using.mclapply(300), times = ntimes$x10)
```

## x100

```{r local_x100}
microbenchmark::microbenchmark(using.mclapply(3000), times = ntimes$x100)
```

__Clean environment of local glmnet__

```{r unload_local}
devtools::unload('.')
#
```

# Cran's glmnet

```{r load_cran}
library(glmnet)
library(doMC)
registerDoMC(cores = n.cores)
using.foreach <- function(var.num) {cv.glmnet(new.x[,seq(var.num)], y, family = 'cox', parallel = T)}
```

## x1

```{r cran_x1}
microbenchmark::microbenchmark(using.foreach(30), times = ntimes$x1)
```

## x10

```{r cran_x10}
microbenchmark::microbenchmark(using.foreach(300), times = ntimes$x10)
```

## x100

```{r cran_x100}
microbenchmark::microbenchmark(using.foreach(3000), times = ntimes$x100)
```

__Unload glmnet__

```{r unload_cran}
unload(inst('glmnet'))
```

# Session Information

```{r session_info}
sessionInfo()
```

