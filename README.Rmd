---
title: "glmnet (averissimo fork)"
output: 
  github_document:
    toc: true
    dev: png
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error = TRUE)
library(microbenchmark)
library(devtools)
library(futile.logger)
```

This is a fork that implements mclapply instead of foreach in cv.glmnet. With `~21%` gains when adding parallization to `cv.coxnet`.

The big improvement that can be seen in the tests below, is when adding `mclapply` in `cv.coxnet` for calculating deviances. It goes from `55s` to `43s` with this test dataset (`21%` average improvement).

# Load local glmnet for tests

```{r local, echo = F}
devtools::load_all('.', recompile = T)
```
## Use dataset from glmnet package

```{r data}
data("CoxExample")
ntimes <- 10
```

## x1

```{r local_x1}
new.x <- matrix(rep(x, 1), nrow = 1000, ncol = 30)
microbenchmark::microbenchmark(
  glmnet::cv.glmnet(new.x, y, family = 'cox', mc.cores = 14)
  , times = 100)
```

## x10

```{r local_x10}
new.x <- matrix(rep(x, 10), nrow = 1000, ncol = 300)
new.x <- new.x + rnorm(length(new.x))
microbenchmark::microbenchmark(
  glmnet::cv.glmnet(new.x, y, family = 'cox', mc.cores = 14)
  , times = ntimes)
```

## x100

```{r local_x100}
new.x <- matrix(rep(x, 100), nrow = 1000, ncol = 3000)
new.x <- new.x + rnorm(length(new.x))
microbenchmark::microbenchmark(
  glmnet::cv.glmnet(new.x, y, family = 'cox', mc.cores = 14)
  , times = ntimes)
```

## Unload libraries

```{r unload_local}
devtools::unload('.')
```

# Load glmnet and doMC library

Dataset is the same as before.


```{r load_cran}
library(doMC)
registerDoMC(cores=14)
library(glmnet)
```

## x1

```{r cran_x1}
new.x <- matrix(rep(x, 1), nrow = 1000, ncol = 30)
microbenchmark::microbenchmark(
  glmnet::cv.glmnet(new.x, y, family = 'cox', parallel = T)
  , times = 100)
```

## x10

```{r cran_x10}
new.x <- matrix(rep(x, 10), nrow = 1000, ncol = 300)
new.x <- new.x + rnorm(length(new.x))
microbenchmark::microbenchmark(
  glmnet::cv.glmnet(new.x, y, family = 'cox', parallel = T)
  , times = ntimes)
```

## x100

```{r cran_x100}
new.x <- matrix(rep(x, 100), nrow = 1000, ncol = 3000)
new.x <- new.x + rnorm(length(new.x))
microbenchmark::microbenchmark(
  glmnet::cv.glmnet(new.x, y, family = 'cox', parallel = T)
  , times = ntimes)
```

## Unload glmnet

```{r unload_cran}
unload(inst('glmnet'))
```

# Session Information

```{r session_info}
sessionInfo()
```

